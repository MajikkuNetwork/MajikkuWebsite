{% extends "base.html" %}
{% block content %}

    <h1>Majikku Network</h1>
    <p class="subtitle">Staff Application Form</p>

    <form id="appForm">
        <h2 class="section-title">General Information</h2>
        
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div class="form-group" style="flex: 1;">
                <label>Discord Name (Verified)</label>
                <input type="text" value="{{ user['username'] }}" class="read-only" readonly>
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Discord ID (Verified)</label>
                <input type="text" value="{{ user['id'] }}" class="read-only" readonly>
            </div>
        </div>

        <div class="form-group">
            <label>What is your Hytale name?</label>
            <input type="text" id="hytale_name" 
                   value="{{ player['username'] if player and player['username'] else '' }}" 
                   {% if player and player['username'] %} class="read-only" readonly {% endif %} 
                   required>
            
            {% if player and player['username'] %}
                <div class="desc-text" style="color: var(--primary); font-weight: bold; margin-top: 5px;">
                    âœ“ Linked via Server Database
                </div>
            {% else %}
                <div class="desc-text">We could not find your account in our database. Please type it manually.</div>
            {% endif %}
        </div>

        <div style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 1;">
                <label>How old are you?</label>
                <input type="number" id="age" required>
            </div>
            <div class="form-group" style="flex: 1;">
                <label>What is your Timezone?</label>
                <input type="text" id="timezone" placeholder="e.g. EST" required>
            </div>
        </div>

        <div class="form-group">
            <label>What are your pronouns?</label>
            <input type="text" id="pronouns" placeholder="e.g. He/Him, They/Them">
        </div>

        <div class="form-group">
            <label>How many hours can you realistically contribute daily/weekly?</label>
            <div class="desc-text">This isn't a determining factor, just to gauge activity.</div>
            <input type="text" id="availability" placeholder="e.g. 2 hours a day" required>
        </div>

        <div class="form-group">
            <label>What language(s) are you fluent in?</label>
            <input type="text" id="languages">
        </div>

        <h2 class="section-title">Select Your Path</h2>
        <p style="text-align:center; margin-bottom: 20px;">What team are you applying for?</p>
        
        <div class="role-grid">
            <div class="role-btn" onclick="showTeam('mod', this)">Moderation</div>
            <div class="role-btn" onclick="showTeam('dev', this)">Development</div>
            <div class="role-btn" onclick="showTeam('build', this)">Build Team</div>
            <div class="role-btn" onclick="showTeam('artist', this)">Artist</div>
            <div class="role-btn" onclick="showTeam('story', this)">Story Teller</div>
            <div class="role-btn" onclick="showTeam('coordinator', this)">Coordinator</div>
            <div class="role-btn" onclick="showTeam('model', this)">Modeling</div>
            <div class="role-btn" onclick="showTeam('tester', this)">Tester</div>
        </div>

        <h2 class="section-title">Miscellaneous</h2>
        <div class="form-group">
            <label>When is your birthday?</label>
            <div class="desc-text">Format: MM/DD (e.g., 09/20)</div>
            <input type="text" id="birthday" placeholder="MM/DD" pattern="\d{2}/\d{2}" title="MM/DD Format" class="misc-answer" data-question="Birthday" required>
        </div>
        <h2 class="section-title">Submission</h2>
        <div class="checkbox-group">
            <input type="checkbox" id="check_discord" required>
            <div>
                <label style="margin:0; display:inline;">Are you in the Discord Server?</label>
                <div class="desc-text"><a href="https://discord.majikku.org" target="_blank" style="color:var(--accent)">https://discord.majikku.org</a></div>
            </div>
        </div>

        <div class="checkbox-group">
            <input type="checkbox" id="check_dms" required>
            <div>
                <label style="margin:0; display:inline;">Is "Direct Messages" enabled?</label>
                <div class="desc-text">This allows the Staff Manager to contact you.</div>
            </div>
        </div>

        <button type="submit" class="submit-btn">Submit Application</button>
    </form>

    <script>
        // (Keep your existing script exactly as is)
        function showTeam(teamId, btnElement) {
            const allSections = document.querySelectorAll('.dynamic-content');
            allSections.forEach(section => { section.classList.remove('visible'); });
            const allButtons = document.querySelectorAll('.role-btn');
            allButtons.forEach(btn => { btn.classList.remove('active'); });
            const targetSection = document.getElementById(teamId);
            if (targetSection) targetSection.classList.add('visible');
            if (btnElement) btnElement.classList.add('active');
        }

        const form = document.getElementById('appForm');
        form.addEventListener('submit', async function(event) {
            event.preventDefault(); 
            const activeBtn = document.querySelector('.role-btn.active');
            if (!activeBtn) { alert("Please select a team path at the top!"); return; }

            const teamName = activeBtn.innerText;
            const visibleSection = document.querySelector('.dynamic-content.visible');
            
            const payload = {
                hytale_name: document.getElementById('hytale_name').value,
                age: document.getElementById('age').value,
                timezone: document.getElementById('timezone').value,
                pronouns: document.getElementById('pronouns').value,
                availability: document.getElementById('availability').value,
                languages: document.getElementById('languages').value,
                team: teamName,
                answers: {}
            };

            if (visibleSection) {
                const inputs = visibleSection.querySelectorAll('.team-answer');
                inputs.forEach(input => { payload.answers[input.getAttribute('data-question')] = input.value; });
            }

            const miscInputs = document.querySelectorAll('.misc-answer');
            miscInputs.forEach(input => { payload.answers[input.getAttribute('data-question')] = input.value; });

            payload.answers["In Discord?"] = document.getElementById('check_discord').checked ? "Yes" : "No";
            payload.answers["DMs Enabled?"] = document.getElementById('check_dms').checked ? "Yes" : "No";

            const btn = document.querySelector('.submit-btn');
            const originalText = btn.innerText;
            btn.innerText = "Sending...";
            btn.disabled = true;

            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.success) {
                    document.querySelector('.container').innerHTML = `
                        <h1 style="color:var(--accent)">Application Sent!</h1>
                        <p style="text-align:center">Thank you for applying to the Majikku Network.</p>
                        <p style="text-align:center"><a href="/" style="color:white">Return Home</a></p>
                    `;
                } else {
                    alert("Error: " + (result.error || "Unknown error"));
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                alert("Network error.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    </script>
{% endblock %}