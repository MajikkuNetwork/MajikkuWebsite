{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 800px; margin-top: 50px;">
    
    <div class="text-center mb-5">
        <h1 style="font-family: 'Cinzel', serif; color: var(--primary);">Submit a Report</h1>
        <p class="text-muted">Help us keep Majikku safe. Please provide as much detail as possible.</p>
    </div>

    <div class="d-flex justify-content-center mb-4">
        <button class="btn btn-neon-toggle btn-neon-red me-3 active" 
                id="btn-player" 
                onclick="switchForm('PLAYER')">
            Report a Player
        </button>
        
        <button class="btn btn-neon-toggle btn-neon-gold" 
                id="btn-staff" 
                onclick="switchForm('STAFF')">
            Report Staff
        </button>
    </div>

    <div class="card bg-dark border-secondary">
        <div class="card-body">
            <form action="/report" method="POST" id="reportForm" novalidate>
                
                <input type="hidden" name="report_type" id="report_type" value="PLAYER">

                <div id="staff-alert" class="alert alert-warning" style="display: none; background-color: rgba(255, 215, 0, 0.1); border-color: #ffd700; color: #ffd700;">
                    <strong>Notice:</strong> This report will be sent <u>only</u> to the Leadership Team. Regular staff will not see this.
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: var(--primary); font-weight: bold;">Name of Offender</label>
                    <input type="text" class="form-control bg-secondary text-white border-0" name="target_name" required placeholder="In-game name or Discord Tag">
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: var(--primary); font-weight: bold;">Server / Origin</label>
                    <select class="form-control bg-secondary text-white border-0" name="server_origin">
                        <option value="Discord Server">Discord Server</option>
                        <option value="Game: Hub">Game: Hub</option>
                        <option value="Game: Survival">Game: Survival</option>
                        <option value="Game: Creative">Game: Creative</option>
                        <option value="Website">Website</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: var(--primary); font-weight: bold;">What happened?</label>
                    <textarea class="form-control bg-secondary text-white border-0" name="reason" rows="5" required placeholder="Please describe the incident in detail..."></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: var(--primary); font-weight: bold;">Evidence (Links)</label>
                    <input type="text" class="form-control bg-secondary text-white border-0" name="evidence" placeholder="Imgur links, YouTube links, or Pastebin logs">
                    <small class="text-muted">For screenshots, please upload to Imgur and paste the link here.</small>
                </div>

                <div class="mb-3 form-check" id="anon-group" style="display: none;">
                    <input type="checkbox" class="form-check-input" name="anonymous" id="anonymous">
                    <label class="form-check-label text-white" for="anonymous">Remain Anonymous? (Leadership will not see your name)</label>
                </div>

                <button type="submit" class="btn-majikku">Submit Report</button>
            </form>
        </div>
    </div>
</div>

<script>
    // ... your existing switchForm function ...

    // Prevent Double-Submission
    document.querySelector('form').addEventListener('submit', function(e) {
        var form = this;
        
        // 1. Check if the form is actually valid first
        if (!form.checkValidity()) {
            // If invalid, let the browser show the error bubbles
            return;
        }

        // 2. If valid, Change button text and Disable it
        var btn = form.querySelector('button[type="submit"]');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
        btn.disabled = true;
        btn.style.opacity = "0.7";
        
        // 3. Since the button is disabled, we must explicitly submit the form now?
        // Actually, preventing default isn't needed if we don't preventDefault().
        // But simply disabling the button on 'submit' event allows the request to fly.
    });
    
    function switchForm(type) {
        // 1. Update the hidden input
        document.getElementById('report_type').value = type;
        
        // 2. Get the buttons
        const btnPlayer = document.getElementById('btn-player');
        const btnStaff = document.getElementById('btn-staff');
        
        // 3. Toggle the Visuals
        if (type === 'PLAYER') {
            btnPlayer.classList.add('active');
            btnStaff.classList.remove('active');
            
            // Hide Special Fields
            document.getElementById('staff-alert').style.display = 'none';
            document.getElementById('anon-group').style.display = 'none';
        } else {
            btnStaff.classList.add('active');
            btnPlayer.classList.remove('active');

            // Show Special Fields
            document.getElementById('staff-alert').style.display = 'block';
            document.getElementById('anon-group').style.display = 'block';
        }
    }
    
    // Initialize default state
    switchForm('PLAYER');

    // DEBUG SCRIPT: Use this to see if the form is actually submitting
    document.querySelector('form').addEventListener('submit', function(event) {
        console.log("Submit button clicked. Form data sending...");
    });
</script>
{% endblock %}